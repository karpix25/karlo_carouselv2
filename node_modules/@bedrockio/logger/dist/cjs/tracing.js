"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getTracePayload = getTracePayload;
exports.useGoogleCloudTracing = useGoogleCloudTracing;
var _api = require("@opentelemetry/api");
var _sdkTraceNode = require("@opentelemetry/sdk-trace-node");
var _opentelemetryCloudTraceExporter = require("@google-cloud/opentelemetry-cloud-trace-exporter");
var _sdkTraceBase = require("@opentelemetry/sdk-trace-base");
var _instrumentation = require("@opentelemetry/instrumentation");
var _instrumentationHttp = require("@opentelemetry/instrumentation-http");
var _instrumentationKoa = require("@opentelemetry/instrumentation-koa");
var _instrumentationMongoose = require("@opentelemetry/instrumentation-mongoose");
var _env = require("./utils/env");
function useGoogleCloudTracing(options = {}) {
  // https://cloud.google.com/trace/docs/setup/nodejs-ot#gke
  // https://github.com/open-telemetry/opentelemetry-js/tree/main/packages/opentelemetry-sdk-trace-node

  const {
    ignoreIncomingPaths = []
  } = options;
  const provider = new _sdkTraceNode.NodeTracerProvider();
  if (_env.isTTY) {
    provider.addSpanProcessor(new _sdkTraceBase.SimpleSpanProcessor(new _sdkTraceBase.ConsoleSpanExporter()));
  } else {
    provider.addSpanProcessor(new _sdkTraceBase.BatchSpanProcessor(new _opentelemetryCloudTraceExporter.TraceExporter()));
  }
  (0, _instrumentation.registerInstrumentations)({
    instrumentations: [new _instrumentationMongoose.MongooseInstrumentation(), new _instrumentationKoa.KoaInstrumentation(), new _instrumentationHttp.HttpInstrumentation({
      ignoreIncomingPaths
    })],
    tracerProvider: provider
  });
  provider.register();
}
function getTracePayload() {
  const context = _api.trace.getSpanContext(_api.context.active());
  if (context) {
    const {
      spanId,
      traceId,
      traceFlags
    } = context;
    return {
      'logging.googleapis.com/spanId': spanId,
      'logging.googleapis.com/trace': traceId,
      'logging.googleapis.com/trace_sampled': traceFlags === 1
    };
  }
}