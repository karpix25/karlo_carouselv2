"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.has = exports.getAllPublic = exports.getAll = exports.get = void 0;
const { parse } = require('./parse');
const { readFileSync, accessSync } = require('fs');
const path = require('path');
function getPath() {
    if (process.env.ENV_CONFIG_PATH) {
        return process.env.ENV_CONFIG_PATH;
    }
    const defaultPath = path.resolve(process.cwd(), '.env');
    try {
        if (accessSync(defaultPath))
            return defaultPath;
    }
    catch (e) { }
    const alternativePath = path.resolve(process.cwd(), 'env.conf');
    try {
        if (accessSync(alternativePath)) {
            console.warn('env.conf should be renamed to .env');
            return alternativePath;
        }
    }
    catch (e) { }
    return defaultPath;
}
let parsed;
let emptyKeys;
const configPath = getPath();
try {
    [parsed, emptyKeys] = parse(readFileSync(configPath, { encoding: 'utf8' }));
}
catch (e) {
    console.error(`Failed to parse .env (${configPath})`);
    throw e;
}
// Ensure process.env[foo] gets popuplated: 3. party libraries can rely on it
const allKeys = parsed.keys();
for (const key of allKeys) {
    if (!process.env[key] && parsed.get(key)) {
        process.env[key] = parsed.get(key);
    }
}
function get(variable, as = 'string') {
    if (!variable) {
        throw new Error('Calling get with null or undefined argument');
    }
    const value = process.env[variable] || parsed.get(variable);
    if (value === undefined) {
        throw Error(`Configuration variable "${variable}" is not exposed as enviroment variable nor was a default provided in \`.env\``);
    }
    if (as === 'string')
        return value;
    if (as === 'boolean')
        return ['true', '1'].includes(value.toLowerCase());
    if (['number', 'float', 'integer'].includes(as))
        return Number(value);
    if (as === 'float')
        return parseFloat(value);
    if (as === 'date')
        return new Date(Date.parse(value));
    if (as === 'json')
        return JSON.parse(value);
    throw Error(`Unknown formatting config.get(${variable}, ${as})`);
}
exports.get = get;
function getAll(onlyParsed = false) {
    const result = {};
    const keys = parsed.keys();
    for (const key of keys) {
        const value = onlyParsed ? parsed.get(key) : process.env[key] || parsed.get(key);
        result[key] = value;
    }
    return result;
}
exports.getAll = getAll;
function getAllPublic(onlyParsed = false) {
    const result = {};
    const keys = parsed.keys();
    for (const key of keys) {
        if (!key.startsWith('PUBLIC_'))
            continue;
        const value = onlyParsed ? parsed.get(key) : process.env[key] || parsed.get(key);
        result[key] = value;
    }
    return result;
}
exports.getAllPublic = getAllPublic;
function has(variable) {
    return process.env[variable] !== undefined || !!parsed.get(variable);
}
exports.has = has;
exports.default = {
    get,
    getAll,
    getAllPublic,
    has,
};
