# Сервис экспорта HTML в PDF и Изображения

Это сервис на базе Docker, предоставляющий JSON API для конвертации HTML в PDF или изображения (PNG/JPG). Сервис использует [Chrome headless browser (Puppeteer)](https://github.com/GoogleChrome/puppeteer), что обеспечивает качество рендеринга, идентичное Google Chrome.

Также сервис включает в себя систему управления шаблонами, позволяющую создавать визуальные макеты и генерировать изображения на их основе с подстановкой данных.

_Примечание по безопасности: Сервис предназначен для работы как микросервис внутри закрытой сети. Не выставляйте его в публичный доступ без дополнительной защиты._

## Запуск

### Через Docker

```bash
docker run -p 2305:2305 bedrockio/export-html
```

### Локальный запуск (для разработки)

```bash
git clone git@github.com:bedrockio/export-html.git
cd export-html
yarn install
yarn start
```

Сервис будет доступен по адресу `http://localhost:2305`.

---

## Работа с шаблонами

Сервис позволяет создавать шаблоны (слои с текстом, изображениями, фигурами) и рендерить их, подставляя динамические данные.

### Структура шаблона

Шаблон представляет собой JSON-объект, содержащий размеры холста и массив элементов.

Пример элемента текста с переменной:
```json
{
  "type": "text",
  "content": "Привет, {{name}}!",
  "x": 100,
  "y": 100,
  "fontSize": 24,
  "color": "#000000"
}
```

При рендеринге, если передать данные `{"name": "Мир"}`, текст превратится в "Привет, Мир!".

---

## API Эндпоинты

### 1. Проверка состояния

#### `GET /health`
Проверка работоспособности сервиса.
**Ответ:**
```json
{ "servedAt": "2023-10-27T10:00:00.000Z" }
```

#### `GET /check-status`
Возвращает количество открытых страниц в браузере.
**Ответ:**
```json
{ "pageCount": 0 }
```

---

### 2. Базовая конвертация (Puppeteer)

#### `POST /1/screenshot`
Создание скриншота из URL или HTML.

**Тело запроса:**
```json
{
  "html": "<h1>Привет Мир</h1>",
  "export": {
    "type": "png",
    "fullPage": true
  }
}
```
Или через URL:
```json
{
  "url": "https://google.com",
  "export": { "type": "jpeg", "quality": 80 }
}
```

#### `POST /1/pdf`
Создание PDF документа.

**Тело запроса:**
```json
{
  "html": "<h1>Счет #123</h1>",
  "export": {
    "format": "A4",
    "printBackground": true
  }
}
```

---

### 3. Управление шаблонами

#### `GET /templates`
Получить список всех доступных шаблонов.

**Ответ:**
```json
[
  { "id": "uuid-...", "name": "Мой шаблон", ... },
  ...
]
```

#### `POST /templates`
Создать новый или обновить существующий шаблон.

**Тело запроса:**
```json
{
  "id": "optional-uuid",
  "name": "Новый шаблон",
  "width": 1080,
  "height": 1080,
  "elements": [...]
}
```

#### `GET /templates/:id`
Получить полную информацию о шаблоне по его ID.

---

### 4. Рендеринг шаблонов

#### `POST /templates/:id/render`
Генерирует изображение (PNG) на основе шаблона, подставляя переданные данные.

**Параметры URL:**
*   `id`: ID шаблона

**Тело запроса (данные для подстановки):**
```json
{
  "title": "Заголовок поста",
  "image_url": "https://example.com/image.jpg",
  "price": "1000 руб."
}
```

Переменные в шаблоне (например `{{title}}`) будут заменены на значения из тела запроса.

**Ответ:**
Бинарные данные изображения (Content-Type: image/png).

---

## Развертывание в Kubernetes

Сервис запускает полноценный браузер Chrome. Каждый запрос открывает новую вкладку. Большое количество одновременных запросов может потреблять много памяти.

Рекомендуется устанавливать лимиты ресурсов (requests/limits) и использовать `podAntiAffinity`, чтобы распределять поды по разным нодам.

Пример конфигурации Deployment см. в файле `k8s-example.yaml` (если есть) или используйте стандартные практики для Node.js приложений с Puppeteer.
